# JIra line item
# pip install pandas openpyxl jira


import re
import pandas as pd
from jira import JIRA

# Step 1: Read and parse the .txt file
with open('test_cases.txt', 'r', encoding='utf-8') as file:
    content = file.read()

# Split individual test cases using "####"
raw_cases = [tc.strip() for tc in content.split("####") if tc.strip()]

test_cases = []
user_story_code = "US-1234"

for raw in raw_cases:
    test_case = {}

    # Extract fields using regex
    test_case["Title"] = user_story_code
    test_case["Test Case ID"] = re.search(r"Test Case Id:\s*(\S+)", raw).group(1)
    test_case["Test Case Name"] = re.search(r"Test Case Name:\s*(.*?)\s*Description:", raw).group(1)
    test_case["Test Case Type"] = re.search(r"Test Case Type:\s*(\S+)", raw).group(1)
    test_case["Description"] = re.search(r"Description:\s*(.*?)\s*Precondition:", raw, re.DOTALL).group(1).strip()
    test_case["Precondition"] = re.search(r"Precondition:\s*(.*?)\s*Test Steps:", raw, re.DOTALL).group(1).strip()
    steps = re.search(r"Test Steps:\s*(.*?)Expected Results:", raw, re.DOTALL).group(1)
    expected = re.search(r"Expected Results:\s*(.*?)Test Data:", raw, re.DOTALL).group(1)
    data = re.search(r"Test Data:\s*(.*)", raw, re.DOTALL).group(1)

    # Clean and join multiline steps, expected results, and data
    test_case["Test Steps"] = ' '.join(line.strip() for line in steps.splitlines() if line.strip())
    test_case["Expected Results"] = ' '.join(line.strip() for line in expected.splitlines() if line.strip())
    test_case["Test Data"] = ', '.join([l.split(':', 1)[-1].strip() for l in data.splitlines() if ':' in l])

    test_cases.append(test_case)

# Step 2: Write to Excel
df = pd.DataFrame(test_cases)
excel_filename = "parsed_test_cases.xlsx"
df.to_excel(excel_filename, index=False)
print(f"Excel file created: {excel_filename}")

# Step 3: Create issues in Jira
# Replace with your Jira credentials
jira_url = 'https://yourcompany.atlassian.net'
jira_email = 'your-email@example.com'
jira_api_token = 'your-api-token'
jira_project_key = 'TEST'  # e.g., project key where these test cases belong

jira = JIRA(server=jira_url, basic_auth=(jira_email, jira_api_token))

for tc in test_cases:
    issue_dict = {
        'project': {'key': jira_project_key},
        'summary': f"{tc['Test Case ID']} - {tc['Test Case Name']}",
        'description': (
            f"*Description:*\n{tc['Description']}\n\n"
            f"*Precondition:*\n{tc['Precondition']}\n\n"
            f"*Test Steps:*\n{tc['Test Steps']}\n\n"
            f"*Expected Results:*\n{tc['Expected Results']}\n\n"
            f"*Test Data:*\n{tc['Test Data']}"
        ),
        'issuetype': {'name': 'Test'},  # or 'Task', 'Bug' depending on your setup
    }

    issue = jira.create_issue(fields=issue_dict)
    print(f"Created issue: {issue.key}")
