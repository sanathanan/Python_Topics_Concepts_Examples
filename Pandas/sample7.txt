
import re
import pandas as pd
from testrail_api import TestRailAPI

# Step 1: Read and parse the .txt file
with open('test_cases.txt', 'r', encoding='utf-8') as file:
    content = file.read()

# Split individual test cases using "####"
raw_cases = [tc.strip() for tc in content.split("####") if tc.strip()]
test_cases = []
user_story_code = "US-1234"  # Replace with actual story code

for raw in raw_cases:
    try:
        test_case = {}

        # Extract fields using regex
        test_case["Title"] = user_story_code
        test_case["Test Case ID"] = re.search(r"Test Case Id:\s*(\S+)", raw).group(1)
        test_case["Test Case Name"] = re.search(r"Test Case Name:\s*(.*?)\s*Description:", raw).group(1).strip()
        test_case["Test Case Type"] = re.search(r"Test Case Type:\s*(\S+)", raw).group(1)
        test_case["Description"] = re.search(r"Description:\s*(.*?)\s*Precondition:", raw, re.DOTALL).group(1).strip()
        test_case["Precondition"] = re.search(r"Precondition:\s*(.*?)\s*Test Steps:", raw, re.DOTALL).group(1).strip()
        steps = re.search(r"Test Steps:\s*(.*?)Expected Results:", raw, re.DOTALL).group(1)
        expected = re.search(r"Expected Results:\s*(.*?)Test Data:", raw, re.DOTALL).group(1)
        data = re.search(r"Test Data:\s*(.*)", raw, re.DOTALL).group(1)

        # Clean and join multiline fields
        test_case["Test Steps"] = ' '.join(line.strip() for line in steps.splitlines() if line.strip())
        test_case["Expected Results"] = ' '.join(line.strip() for line in expected.splitlines() if line.strip())
        test_case["Test Data"] = ', '.join([l.split(':', 1)[-1].strip() for l in data.splitlines() if ':' in l])

        test_cases.append(test_case)
    except AttributeError as e:
        print(f"Error parsing test case:\n{raw}\nError: {e}")

# Step 2: Write to Excel
df = pd.DataFrame(test_cases)
excel_filename = "parsed_test_cases.xlsx"
df.to_excel(excel_filename, index=False)
print(f"Excel file created: {excel_filename}")

# Step 3: Create test cases in TestRail
# Replace these values
testrail_url = 'https://yourcompany.testrail.io'
testrail_email = 'your-email@example.com'
testrail_api_key = 'your-api-key'
project_id = 1  # Replace with actual project ID
suite_id = 1    # Replace with actual suite ID
section_id = 1  # Replace with actual section ID

api = TestRailAPI(testrail_url, testrail_email, testrail_api_key)

for tc in test_cases:
    title = f"{tc['Test Case ID']} - {tc['Test Case Name']}"
    steps = f"{tc['Test Steps']}\n\nExpected:\n{tc['Expected Results']}\n\nTest Data:\n{tc['Test Data']}"
    
    api.cases.add_case(section_id, json={
        'title': title,
        'template_id': 1,  # Optional; depends on your TestRail config
        'type_id': 1,      # Optional; maps to test case type
        'priority_id': 2,  # Optional
        'custom_preconds': tc['Precondition'],
        'custom_steps_separated': [{'content': steps, 'expected': tc['Expected Results']}],
        'custom_description': tc['Description']
    })
    print(f"Created TestRail case: {title}")
